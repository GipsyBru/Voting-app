<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Activity Ideas & Voting</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f5f5f5;
    padding: 24px;
  }
  .container {
    max-width: 800px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 12px;
  }
  input, textarea, button {
    font-size: 16px;
    padding: 8px;
    width: 100%;
    box-sizing: border-box;
  }
  button { cursor: pointer; margin-top: 8px; }
  .hidden { display: none; }
  .add { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
  .add input, .add textarea { width: auto; flex: 1 1 200px; }

  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ccc; padding: 8px; }
  th { background: #eee; }

  .suggestions {
    border: 1px solid #ccc;
    border-top: none;
    max-height: 150px;
    overflow-y: auto;
  }
  .suggestion {
    padding: 8px;
    cursor: pointer;
  }
  .suggestion:hover {
    background: #f0f0f0;
  }
</style>
</head>
<body>

<div class="container">

  <!-- HOME SCREEN -->
  <div id="homeScreen">
    <h1>Idea & Voting Spaces</h1>

    <h3>Create a new space</h3>
    <input id="newSpaceName" placeholder="Choose a space name">
    <input id="newSpacePassword" placeholder="Choose a password" type="password">
    <button onclick="createSpace()">Create space</button>

    <hr style="margin:30px 0;">

    <h3>Open existing space</h3>
    <input
      id="openSpaceName"
      placeholder="Start typing space name"
      oninput="updateSuggestions()"
      autocomplete="off"
    >
    <div id="suggestions" class="suggestions"></div>

    <input id="openSpacePassword" placeholder="Password" type="password">
    <button onclick="openSpace()">Open space</button>

    <p id="homeMsg" style="color:red;"></p>
  </div>

  <!-- DIRECT ACCESS SCREEN -->
  <div id="directAccessScreen" class="hidden">
    <h2 id="directTitle"></h2>
    <p>Please enter the password to access this space.</p>
    <input id="directPassword" type="password" placeholder="Password">
    <button onclick="openSharedSpace()">Enter</button>
    <p id="directMsg" style="color:red;"></p>
  </div>

  <!-- MAIN APP -->
  <div id="mainApp" class="hidden">
    <button onclick="goHome()">üè† Home</button>
    <button onclick="shareSpace()">üîó Share</button>

    <div style="font-size:14px;color:#555;margin-top:10px;">
      <span id="spaceName"></span>
    </div>

    <h1 style="text-align:center;">Activity Ideas & Voting</h1>

    <div class="add">
      <input id="nameInput" placeholder="Your name">
      <input id="titleInput" placeholder="Activity title">
      <textarea id="detailsInput" rows="2" placeholder="Activity details"></textarea>
      <button onclick="addIdea()">Add Idea</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Title</th>
          <th>Details</th>
          <th>Votes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ideasTable"></tbody>
    </table>
  </div>

</div>

<script>
let spaces = JSON.parse(localStorage.getItem("spaces") || "{}");
let currentSpace = null;
let sharedSpaceName = null;

/* Ensure existing space */
if (!spaces["Islandsbryggeskole BH-Z 2026"]) {
  spaces["Islandsbryggeskole BH-Z 2026"] = {
    password: "1234",
    ideas: []
  };
  saveSpaces();
}

function saveSpaces() {
  localStorage.setItem("spaces", JSON.stringify(spaces));
}

function show(id) {
  homeScreen.classList.add("hidden");
  mainApp.classList.add("hidden");
  directAccessScreen.classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}

/* ---------- SHARE LOGIC ---------- */

function shareSpace() {
  const url = `${location.origin}${location.pathname}?space=${encodeURIComponent(currentSpace)}`;
  navigator.clipboard.writeText(url);
  alert("Share link copied to clipboard!");
}

/* ---------- URL HANDLING ---------- */

function checkForSharedLink() {
  const params = new URLSearchParams(window.location.search);
  const space = params.get("space");

  if (space && spaces[space]) {
    sharedSpaceName = space;
    directTitle.textContent = space;
    show("directAccessScreen");
    return true;
  }
  return false;
}

function openSharedSpace() {
  const password = directPassword.value;
  if (password === spaces[sharedSpaceName].password) {
    currentSpace = sharedSpaceName;
    spaceName.textContent = currentSpace;
    directPassword.value = "";
    show("mainApp");
    render();
  } else {
    directMsg.textContent = "Incorrect password.";
  }
}

/* ---------- HOME AUTOCOMPLETE ---------- */

function updateSuggestions() {
  const input = openSpaceName.value.toLowerCase().trim();
  suggestions.innerHTML = "";

  if (!input) return;

  const matches = Object.keys(spaces).filter(n =>
    n.toLowerCase().includes(input)
  );

  if (!matches.length) {
    suggestions.innerHTML =
      `<div class="suggestion" style="color:#888;">No matching spaces</div>`;
    return;
  }

  matches.forEach(name => {
    const div = document.createElement("div");
    div.className = "suggestion";
    div.textContent = name;
    div.onclick = () => {
      openSpaceName.value = name;
      suggestions.innerHTML = "";
    };
    suggestions.appendChild(div);
  });
}

/* ---------- SPACE MANAGEMENT ---------- */

function createSpace() {
  const name = newSpaceName.value.trim();
  const password = newSpacePassword.value.trim();
  if (!name || !password) return;

  if (spaces[name]) {
    homeMsg.textContent = "Space already exists.";
    return;
  }

  spaces[name] = { password, ideas: [] };
  saveSpaces();
  openSpace(name, password);
}

function openSpace(nameParam, passParam) {
  const name = nameParam || openSpaceName.value.trim();
  const password = passParam || openSpacePassword.value.trim();

  const space = spaces[name];
  if (!space || space.password !== password) {
    homeMsg.textContent = "Incorrect space name or password.";
    return;
  }

  currentSpace = name;
  spaceName.textContent = name;
  openSpaceName.value = "";
  openSpacePassword.value = "";
  suggestions.innerHTML = "";
  homeMsg.textContent = "";
  show("mainApp");
  render();
}

function goHome() {
  currentSpace = null;
  newSpaceName.value = "";
  newSpacePassword.value = "";
  openSpaceName.value = "";
  openSpacePassword.value = "";
  suggestions.innerHTML = "";
  homeMsg.textContent = "";
  history.replaceState({}, "", location.pathname);
  show("homeScreen");
}

/* ---------- IDEAS ---------- */

function render() {
  const ideas = spaces[currentSpace].ideas;
  ideas.sort((a,b)=>b.votes-a.votes);
  ideasTable.innerHTML = "";

  if (!ideas.length) {
    ideasTable.innerHTML =
      `<tr><td colspan="5" style="text-align:center;color:#555;">No ideas yet.</td></tr>`;
    return;
  }

  ideas.forEach(i => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i.name}</td>
      <td>${i.title}</td>
      <td>${i.details}</td>
      <td><button onclick="vote(${i.id})">üëç</button> ${i.votes}</td>
      <td><button onclick="deleteIdea(${i.id})">üóë</button></td>
    `;
    ideasTable.appendChild(tr);
  });
}

function addIdea() {
  if (!nameInput.value || !titleInput.value) return;
  spaces[currentSpace].ideas.push({
    id: Date.now(),
    name: nameInput.value,
    title: titleInput.value,
    details: detailsInput.value,
    votes: 0
  });
  nameInput.value = titleInput.value = detailsInput.value = "";
  saveSpaces();
  render();
}

function vote(id) {
  const idea = spaces[currentSpace].ideas.find(i => i.id === id);
  if (idea) {
    idea.votes++;
    saveSpaces();
    render();
  }
}

function deleteIdea(id) {
  const code = prompt("Enter space password:");
  if (code === spaces[currentSpace].password) {
    spaces[currentSpace].ideas =
      spaces[currentSpace].ideas.filter(i => i.id !== id);
    saveSpaces();
    render();
  }
}

/* ---------- INIT ---------- */

if (!checkForSharedLink()) {
  show("homeScreen");
}
</script>

</body>
</html>
